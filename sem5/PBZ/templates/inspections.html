{% extends "base.html" %}

{% block content %}
<h1>Управление техническими осмотрами</h1>

<div class="form-section">
    <h2>Добавить новый осмотр</h2>
    <form method="POST" action="{{ url_for('add_inspection') }}">
        <div class="form-group">
            <label>Автомобиль:</label>
            <select name="car_license_plate" required>
                <option value="">Выберите автомобиль</option>
                {% for car in cars %}
                <option value="{{ car[1] }}">{{ car[1] }} ({{ car[4] }} {{ car[3] }}) - {{ car[8] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Сотрудник ГАИ:</label>
            <select name="inspector_id" required>
                <option value="">Выберите сотрудника</option>
                {% for inspector in inspectors %}
                <option value="{{ inspector[0] }}">{{ inspector[1] }} ({{ inspector[3] }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Дата осмотра:</label>
            <input type="date" name="inspection_date" max="{{ current_date }}" required>
        </div>
        <div class="form-group">
            <label>Результат:</label>
            <select name="result" required>
                <option value="true">Пройден</option>
                <option value="false">Не пройден</option>
            </select>
        </div>
        <div class="form-group">
            <label>Заключение:</label>
            <textarea name="conclusion" rows="3"></textarea>
        </div>
        <button type="submit">Добавить осмотр</button>
    </form>
</div>

<h2>История осмотров</h2>
{% if inspections %}
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Автомобиль</th>
            <th>Двигатель</th>
            <th>Марка</th>
            <th>Цвет</th>
            <th>Сотрудник</th>
            <th>Дата</th>
            <th>Результат</th>
            <th>Заключение</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for inspection in inspections %}
        <tr>
            <form method="POST" action="{{ url_for('edit_inspection') }}">
            <td>
                <input type="hidden" name="inspection_id" value="{{ inspection[0] }}">
                {{ inspection[0] }}
            </td>
            <td>
                <select name="car_license_plate" required>
                    {% for car in cars %}
                    <option value="{{ car[1] }}" {% if car[1] == inspection[1] %}selected{% endif %}>
                        {{ car[1] }} ({{ car[4] }})
                    </option>
                    {% endfor %}
                </select>
            </td>
            <td>{{ inspection[6] }}</td>
            <td>{{ inspection[7] }}</td>
            <td>{{ inspection[8] }}</td>
            <td>
                <select name="inspector_id" required>
                    {% for inspector in inspectors %}
                    <option value="{{ inspector[0] }}" {% if inspector[0] == inspection[2] %}selected{% endif %}>
                        {{ inspector[1] }}
                    </option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <input type="date" name="inspection_date" value="{{ inspection[3] }}" max="{{ current_date }}" required>
            </td>
            <td>
                <select name="result" required>
                    <option value="true" {% if inspection[4] %}selected{% endif %}>Пройден</option>
                    <option value="false" {% if not inspection[4] %}selected{% endif %}>Не пройден</option>
                </select>
            </td>
            <td>
                <textarea name="conclusion" rows="2">{{ inspection[5] or '' }}</textarea>
            </td>
            <td class="actions">
                <button type="submit">Обновить</button>
                <a href="{{ url_for('delete_inspection', inspection_id=inspection[0]) }}" 
                   onclick="return confirm('Удалить запись об осмотре?')" 
                   class="btn-danger">Удалить</a>
            </td>
            </form>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>Осмотры не найдены.</p>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Установка максимальной даты (сегодня)
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="inspection_date"]').max = today;
        
        const editForms = document.querySelectorAll('form[action="{{ url_for("edit_inspection") }}"]');
        editForms.forEach(form => {
            const dateInput = form.querySelector('input[name="inspection_date"]');
            dateInput.max = today;
        });
    });
</script>
{% endblock %}